{% extends 'base.html' %}
{% load static %} 
{% load i18n %}
{% block title %}{% trans 'æ•æ„Ÿè³‡æ–™ç”³è«‹è³‡è¨Š' %}ï½œ{% endblock %}

{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/manager/sensitive_apply_info.css' %}?v7" />
{% endblock style %}

{% block head %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
{% endblock head %}
{% block body %}
{% csrf_token %}
<input type="hidden" name="menu" value="{{ menu }}">
<div class="path"> 
    <div class="main_1240"> 
        <a href="{% url 'index' %}" class="home"></a> <span>></span> <p> {% trans 'æ•æ„Ÿè³‡æ–™ç”³è«‹è³‡è¨Š' %}</p>
    </div>
</div>
 
<div class="nbn_title">
</div>
<div class="main_1240"> 
    {% if is_authenticated %}
        <div class="rightbox_content">
            <div class="item">
            <div class="from_area">
                <div class="w_border10_box application_form panel">
                    <div class="box-title"><div class="dottt"></div>æŸ¥è©¢æ¢ä»¶</div>
                    <div class="form_box panel fs-14px">
                        {{ query|safe }}
                    </div>

                    {% if data_count != '' %}
                    <hr>
                    <div class="box-title"><div class="dottt"></div>æŸ¥è©¢ç­†æ•¸</div>
                    <div class="form_box panel fs-14px">
                        {{ data_count|safe }}
                    </div>
                    {% endif %}

                    <hr>
                    <div class="box-title"><div class="dottt"></div>ç”³è«‹è©³ç´°è³‡è¨Š</div>
                    <div class="form_box panel fs-14px">
                        <form id="detailForm">
                        {% csrf_token %}
                        <div class="inpu_3">
                            <div class="input_item">
                                <p>ç”³è«‹äººå§“å</p>
                                <input name="applicant" value="{{ detail.applicant }}" type="text" disabled>
                            </div>
                            <div class="input_item">
                                <p>è¯çµ¡é›»è©±</p>
                                <input name="phone" value="{{ detail.phone }}" type="text" disabled>
                            </div>
                            <div class="input_item">
                                <p>è¯çµ¡åœ°å€</p>
                                <input name="address" value="{{ detail.address }}" type="text" disabled>
                            </div> 
                        </div>
                        <div class="inpu_3">
                            <div class="input_item">
                                <p>ç”³è«‹äººEmail</p>
                                <input name="applicant_email" value="{{ detail.applicant_email }}" type="text" disabled>
                            </div>
                            <div class="input_item">
                                <p>ç”³è«‹äººæ‰€å±¬å–®ä½</p>
                                <input name="affiliation" value="{{ detail.affiliation }}" type="text" disabled>
                            </div>
                            <div class="input_item">
                                <p>ç”³è«‹äººè·ç¨±</p>
                                <input name="job_title" value="{{ detail.job_title }}" type="text" disabled>
                            </div>
                        </div>
                        <div class="{% if  detail.type == '1' %}inpu_3{% else %}inpu_2{% endif %}">
                            <div class="input_item">
                                <p>è¨ˆç•«é¡å‹</p>
                                <input name="type" value="{% if detail.type == '0' %}å€‹äººç ”ç©¶è¨ˆç•«{% else %}å§”è¾¦å·¥ä½œè¨ˆç•«{% endif %}" type="text" disabled>
                            </div>
                            <div class="input_item">
                                <p class="project_type">{% if detail.type == '0' %}å€‹äººç ”ç©¶è¨ˆç•«åç¨±{% else %}å§”è¾¦å·¥ä½œè¨ˆç•«{% endif %}</p>
                                <input name="project_name" value="{{ detail.project_name }}" type="text" disabled>
                            </div>
                            {% if  detail.type == '1' %}
                            <div class="input_item p_affli">
                                <p>å§”è¨—è¨ˆç•«å–®ä½</p>
                                <input name="project_affiliation" value="{{ detail.project_affiliation }}" type="text" disabled>
                            </div>
                            {% endif %}
                        </div>
                        <div class="inpu_3">
                            {% if  detail.type == '1' %}
                            <div class="input_item p_principal">
                                <p>è¨ˆç•«ä¸»æŒäººå§“å</p>
                                <input name="principal_investigator" value="{{ detail.principal_investigator }}" type="text" disabled>
                            </div> 
                            {% endif %}
                        </div>
                        <div class="text_area">
                            <p>è¨ˆç•«æ‘˜è¦
                                {% if detail.research_proposal %}
                                    <a class="ml-5px search-again-a" target="_blank" href="/media/{{ detail.research_proposal }}">ç ”ç©¶è¨ˆç•«æ›¸ ğŸ”—</a>
                                {% endif %}
                            </p>
                            <textarea name="abstract" disabled>{{ detail.abstract }}</textarea>
                        </div>
                        <div class="text_area">
                            <input type="checkbox" name="is_agreed_report" {% if detail.is_agreed_report == True %} checked {% endif %} disabled>  æ˜¯å¦åŒæ„æä¾›ç ”ç©¶æˆæœ</input>
                            {% if not is_self %}
                            <a class="applicant_refs ml-5px search-again-a">ç”³è«‹è€…æ›¾æä¾›æˆæœåƒè€ƒ ğŸ”—</a>
                            {% endif %}
                        </div>
                        </form>
                        <form id="downloadApplicantReport" action="{% url 'download_applicant_sensitive_report' %}" method="POST">
                            <input type="hidden" name="applicant_user_id" value="{{ detail.applicant_user_id }}">
                            {% csrf_token %}
                        </form>
                        <div class="apply_peo">
                            <p class="title">æ­¤æ‰¹ç”³è«‹è³‡æ–™å…¶ä»–ä½¿ç”¨è€…</p>
                            {% if detail.users.length > 0 %}

                            {% for u in detail.users %}
                            <div class="item_set1">
                                <span class="ml-10px">å§“å</span>
                                <input type="text" value="{{ u.user_name }}" disabled>
                                <span class="ml-10px">å–®ä½</span>
                                <input type="text" value="{{ u.user_affiliation }}" disabled>
                                <span class="ml-10px">è·ç¨±</span>
                                <input type="text" name="user_job_title" value="{{ u.user_job_title }}" disabled>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="item_set1 bg-transparent">ç„¡</div>
                            {% endif %}
                        </div>
                    </div>
                    <hr>
                    <div class="box-title"><div class="dottt"></div>å¯©æ ¸çµæœ</div>
                    {% if view_only %}
                    <div class="result_table mt-10px fs-14px">
                        <table class="table_style4">
                            <tr>
                                <td>{% trans 'å¯©æ ¸å–®ä½' %}</td>
                                <td>{% trans 'å¯©æ ¸è€…å§“å' %}</td>
                                <td>{% trans 'å¯©æ ¸æ„è¦‹' %}</td>
                                <td>{% trans 'å¯©æ ¸çµæœ' %}</td>
                            </tr>
                            {% for c in comment %}
                                {{ c|safe }}
                            {% endfor %}
                        </table>
                    </div>
                    {% else %}

                        {% if is_transferred %}

                            <button class="send-transferred mt-15px" disabled>å·²è½‰äº¤çµ¦å–®ä½å¯©æ ¸</button>

                        {% else %}


                            <div class="form_box panel fs-14px">
                                <form id="reviewForm">
                                <input type="hidden" name="query_id" value="{{ detail.query_id }}">
                                <input type="hidden" name="sdr_id" value="{{ sdr_id|default_if_none:'' }}">
                                {% csrf_token %}
                                <div class="inpu_2">
                                    <div class="input_item">
                                        <p>å¯©æ ¸è€…å§“å</p>
                                        <input name="reviewer_name" type="text" {% if review.status != 'pending' %} disabled {% endif %} value="{% if review.reviewer_name == '' %}{{ request.user.name }}{% else %}{{ review.reviewer_name }}{% endif %}">
                                    </div>
                                </div>
                                <div class="text_area">
                                    {% comment %} éœ€è¦åˆ¤æ–·æ˜¯ä¸æ˜¯éœ€è¦å¯©æ ¸çš„ or åªæ˜¯æŸ¥çœ‹ç”¨çš„ {% endcomment %}
                                    <p>å¯©æ ¸çµæœ</p>
                                    <textarea name="comment"{% if review.status != 'pending' %} disabled {% endif %}>{{ review.comment|default_if_none:"" }}</textarea>
                                </div>
                                <div class="inpu_2">
                                    <div class="input_item">
                                        <p>é€šéèˆ‡å¦</p>
                                        <select name="status" {% if review.status != 'pending' %} disabled {% endif %}>
                                            <option value="pass" {% if review.status == 'pass' %} selected {% endif %}>é€šé</option>
                                            <option value="fail" {% if review.status == 'fail' %} selected {% endif %}>ä¸é€šé</option>
                                        </select>
                                    </div>
                                </div>
                                </form>
                            </div>                
                            {% if review.status == 'pending' %}
                                <button class="send_bt send send-check mt-15px">ç¢ºèªé€å‡º</button>
                                {% if from_system == 'true' %}
                                    <button class="send_bt send-partial-transfer send mt-15px">éƒ¨åˆ†è½‰äº¤çµ¦å–®ä½å¯©æ ¸</button>
                                    <button class="send_bt send-transfer send mt-15px">å…¨éƒ¨è½‰äº¤çµ¦å–®ä½å¯©æ ¸</button>
                                {% endif %}
                            {% else %}
                            <button class="send-submitted mt-15px" disabled>å¯©æ ¸å·²å®Œæˆä¸å¾—ä¿®æ”¹</button>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
			</div>
		</div>
        </div>
        </div>

        {% else %}
        {% trans 'æ‚¨çš„æ¬Šé™ä¸è¶³' %}
        {% endif %}
    </div>

    </div>

</div>



<!--ç¢ºèªé€å‡ºpop-->
<div class="messageboxfix submit-check d-none">
    <div class="message_box">
        <div class="informationicon">!</div>
        <p>é€å‡ºå¾Œç„¡æ³•ä¿®æ”¹ï¼Œç¢ºèªé€å‡ºï¼Ÿ</p>
        <div class="btn_area">
            <button class="hide_submit-check">å–æ¶ˆ</button>
            <button class="send_review">ç¢ºèª</button>
        </div>
    </div>
</div>




 <!--å…¨éƒ¨è½‰äº¤pop-->
<div class="messageboxfix submit-transfer d-none">
	<div class="message_box">
		<div class="informationicon">!</div>
		<p>é€å‡ºå¾Œç„¡æ³•ä¿®æ”¹ï¼Œç¢ºèªé€å‡ºï¼Ÿ</p>
		<div class="btn_area">
			<button class="hide_submit-transfer">å–æ¶ˆ</button>
			<button class="transferRequest">ç¢ºèª</button>
		</div>
	</div>
</div> 


<!--éƒ¨åˆ†è½‰äº¤pop-->
<div class="messageboxfix partial-pop d-none">
	<div class="message_box">
		<div class="informationicon">!</div>
        è«‹é¸æ“‡æ¬²è½‰äº¤çš„å–®ä½ï¼š
        <select class="fs-14px" id="partial-partner-select" name="partial_partner_id">
            {% for p in partners %}
            <option value="{{ p.id }}">{{ p.select_title }}</option>
            {% endfor %}
        </select>
        {% if already_transfer_partners|length > 0 %}
        <p class="fs-14px f-italic" id="already_transfer_partners">
            *å·²è½‰äº¤å–®ä½ï¼š{{ already_transfer_partners|join:"ã€" }}
        </p>
        {% endif %}
		<p class="fs-16px">é€å‡ºå¾Œç„¡æ³•ä¿®æ”¹ï¼Œç¢ºèªé€å‡ºï¼Ÿ</p>
		<div class="btn_area">
			<button class="hide_submit-partial-transfer">å–æ¶ˆ</button>
			<button class="partialTransferRequest">ç¢ºèª</button>
		</div>
	</div>
</div>

{% endblock %}
{% block script %}
<script src="{% static 'js/manager/sensitive_apply_info.js' %}?v13"></script>
{% endblock script %}

            {% comment %} $('#partial-partner-select').html('')

            if (response.partners.length > 0){
                
                for (p of response.partners){
                    $('#partial-partner-select').append(`<option value="${p.id}">${p.select_title}</option>`)
                }

                if (response.already_transfer_partners.length > 0){
                    $('#already_transfer_partners').html(`*å·²è½‰äº¤å–®ä½ï¼š${response.already_transfer_partners.join('ã€')}`)
                } else {
                    $('#already_transfer_partners').html('')
                }

            } else {

                if (response.has_partial_transferred == true){
                    $('.send-transferred').removeClass('d-none')
                    $('.send-partial-transfer').addClass('d-none')
                }

                
            } {% endcomment %}
