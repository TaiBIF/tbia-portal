{% extends './base.html' %} 
{% load tags %} 
{% load static %}
{% block head %}
<style>
  .popbg .wbox_center .dot_area .dot {
    cursor: pointer;
    width: 14px;
    height: 14px;
    background: #DDDDDD;
    border-radius: 50%;
    transition: all .1s;
    -moz-transition: all .1s;
    -o-transition: all .1s;
    -ms-transition: all .1s;
    -webkit-transition: all .1s;
    margin: 0px 5px
}

@media only screen and (min-width: 1000px) {
    .popbg .wbox_center .dot_area .dot:hover {
        background: #76A578;
        transition: all .1s;
        -moz-transition: all .1s;
        -o-transition: all .1s;
        -ms-transition: all .1s;
        -webkit-transition: all .1s
    }
}

.popbg .wbox_center .dot_area .dot.now {
    background: #76A578;
    transition: all .1s;
    -moz-transition: all .1s;
    -o-transition: all .1s;
    -ms-transition: all .1s;
    -webkit-transition: all .1s
}

</style>
{% endblock head %}
{% block body %}
<div class="path">
  <div class="main_1240">
    <a href="{% url 'index' %}" class="home"></a> <span>></span>
    <p>全站搜尋結果</p>
  </div>
</div>

<div class="nbn_title">
  <h2>全站搜尋結果</h2>
</div>
<div class="main_1240">
  <div class="searchbar_top">
    <div class="left_search">
      <div class="input_item">
        <form action="{% url 'search_full' %}" method="GET">
          <input type="text" name="keyword" placeholder="請輸入關鍵字" value="{{ keyword }}"/>
          <button>
            <img src="{% static 'image/search_icon.svg' %}" alt="" />
          </button>
        </form>
      </div>
      <!-- 
      <div style="display: flex">
        <p style="vertical-align: middle; line-height: 24px">搜尋"苦苓"="楝"</p> 
        <img style="padding-left: 5px; cursor: pointer" onclick='window.open("{% url "qa" %}")' src="{% static 'image/quesmark.svg' %}" />
      </div>
      --> 
    </div>
    <div class="rightbox_select">
      <p>想找到更精準的資料嗎？<br />試試條件搜尋</p>
      <div class="icon_two">
        <div class="item">
          <a href="#">
            <img src="{% static 'image/mapicon.svg' %}" alt="" />
            <span>物種出現紀錄查詢</span>
          </a>
          <a href="" class="hvmask">物種出現紀錄查詢</a>
          <div class="line"></div>
        </div>
        <div class="item">
          <a href="#">
            <img src="{% static 'image/libraryicon.svg' %}" alt="" />
            <span>⾃然史典藏查詢</span>
          </a>
          <a href="" class="hvmask">⾃然史典藏查詢</a>
        </div>
      </div>
    </div>
  </div>

  <div class="two_cont_area">
    <div class="left_menu mbmove">
      <!--手機用的按鈕-->
      <div class="mb_fixed_btn">
        <p>類<br />別<br />篩<br />選</p>
        <span>關閉</span>
      </div>
      <div class="mb_scroll">
        <ul>
          <li>
            <a href="#" onclick="focusComponent('all')" class="big_link rd_click">
              <p>所有結果</p>
              <div class="arr"></div>
            </a>
          </li>
          <li>
            <div class="big_link">
              <div class="maskfor_click rd_click"></div>
              <p>
                物種出現紀錄
                <!-- <a href="{% url 'qa' %}" target="_blank" class="qusemark"></a> -->
                <a href="#" class="qusemark"></a>
              </p>
              <div class="arrd"></div>
            </div>
            <div class="second_menu">
              <a href="javascript:;" onclick="focusComponent('item_occ')">全部({{ occurrence.count }})</a>
              {% for i in occurrence.rows %} 
              <a href="javascript:;" onclick="focusCards('occ','{{ i.key }}')">{{ i.title }}({{ i.total_count }})</a>
              {% endfor %}
            </div>
          </li>
          <li>
            <div class="big_link">
              <div class="maskfor_click rd_click"></div>
              <p>
                ⾃然史典藏
                <!-- <a href="{% url 'qa' %}" target="_blank" class="qusemark"></a> -->
                <a href="#" class="qusemark"></a>
              </p>
              <div class="arrd"></div>
            </div>
            <div class="second_menu">
              <a href="javascript:;" onclick="focusComponent('item_col')">全部({{ collection.count }})</a>
              {% for i in collection.rows %} 
                <a href="javascript:;" onclick="focusCards('col','{{ i.key }}')">{{ i.title }}({{ i.total_count }})</a>
              {% endfor %}
            </div>
          </li>

          <li>
            <a href="#" onclick="focusComponent('item_news')" class="big_link rd_click">
              <p>新聞公告</p>
              <div class="arr"></div>
            </a>
          </li>
          <li>
            <a href="#" onclick="focusComponent('item_event')" class="big_link rd_click">
              <p>活動公告</p>
              <div class="arr"></div>
            </a>
          </li>
          <li>
            <a href="#" onclick="focusComponent('item_project')" class="big_link rd_click">
              <p>計畫徵求</p>
              <div class="arr"></div>
            </a>
          </li>
          <li>
            <a href="#" onclick="focusComponent('item_resource')" class="big_link rd_click">
              <p>開放資料相關資源</p>
              <div class="arr"></div>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="rightbox_content">
      <!----- 所有結果 內容欄 ----->


      <!----- 物種出現紀錄 ----->
      <div class="item item_occ">
        <div class="titlebox_line">
          <div class="title">
            <p>物種出現紀錄 ({{ occurrence.count }})</p>
            <div class="line"></div>
          </div>
        </div>
        {% if occurrence.count > 0 %}
          <ul class="card_list_1 occ-card">
            {% for i in occurrence.card %}
              <li onclick="getRecords('occ','{{ i.matched_col }}','{{ i.matched_value }}','{{ i.val }}','{{ i.count }}','1')">
                <div class="num">{{ i.count }}</div>
                <p>中文名：{{ i.common_name_c|highlight:keyword }}</p>
                <p>學名：{{ i.val|highlight:keyword }}</p>
                {% if i.matched_col != '中文名' and i.matched_col != '學名'  %}
                <p>{{ i.matched_col }}：{{ i.matched_value|highlight:keyword }}</p>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
        <!--無資時料顯示-->
        <div class="no_data">暫無資料</div>
        {% endif %}
        <!--超過9個才有更多按鈕-->
        {% if occurrence.more %}
        <a href="javascript:;" onclick="getMoreCards('.occ-card','#occ_offset','.occ_more','false')" class="more occ_more"> 更多結果 </a>
        <input type="hidden" id="occ_offset" value="9">
        {% endif %}
      </div>


      <!----- 自然史典藏 ----->
      <div class="item item_col">
        <div class="titlebox_line">
          <div class="title">
            <p>⾃然史典藏 ({{ collection.count }})</p>
            <div class="line"></div>
          </div>
        </div>
        {% if collection.count > 0 %}
          <ul class="card_list_1 col-card">
            {% for i in collection.card %}
            <li onclick="getRecords('col','{{ i.matched_col }}','{{ i.matched_value }}','{{ i.val }}','{{ i.count }}','1')">
              <div class="num">{{ i.count }}</div>
              <p>中文名：{{ i.common_name_c|highlight:keyword }}</p>
              <p>學名：{{ i.val|highlight:keyword }}</p>
              {% if i.matched_col != '中文名' and i.matched_col != '學名'  %}
              <p>{{ i.matched_col }}：{{ i.matched_value|highlight:keyword }}</p>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        {% else %}
        <!--無資時料顯示-->
        <div class="no_data">暫無資料</div>
        {% endif %}
        <!--超過9個才有更多按鈕-->
        {% if collection.more %}
        <a href="javascript:;" onclick="getMoreCards('.col-card','#col_offset','.col_more','false')" class="more col_more"> 更多結果 </a>
        <input type="hidden" id="col_offset" value="9">
        {% endif %}
      </div>


      <!-- 新聞公告 -->
      <div class="item item_news">
        <div class="titlebox_line">
          <div class="title">
            <p>新聞公告 ({{ news.count }})</p>
            <div class="line"></div>
          </div>
        </div>
        {% if news.count > 0 %}
        <ul class="card_list_2 news-card">
          {% for i in news.rows %}
          <li>
            <div class="nstitle">{{ i.title|highlight:keyword }}</div>
            <p>{{ i.content|highlight:keyword }}</p>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <!--無資時料顯示-->
        <div class="no_data">暫無資料</div>
        {% endif %}
        <!--超過6個才有更多按鈕-->
        {% if news.count > 6 %}
        <a href="javascript:;" onclick="getMoreDocs('news', '#news_offset', '.more_news', '.news-card')" class="more more_news"> 更多結果 </a>
        <input type="hidden" id="news_offset" value="6">
        {% endif %}
      </div>


      <!-- 活動公告 -->
      <div class="item item_event">
        <div class="titlebox_line">
          <div class="title">
            <p>活動公告 ({{ event.count }})</p>
            <div class="line"></div>
          </div>
        </div>
        {% if event.count > 0 %}
        <ul class="card_list_2 event-card">
          {% for i in event.rows %}
          <li>
            <div class="nstitle">{{ i.title|highlight:keyword }}</div>
            <p>{{ i.content|highlight:keyword }}</p>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <!--無資時料顯示-->
        <div class="no_data">暫無資料</div>
        {% endif %}
        <!--超過6個才有更多按鈕-->
        {% if event.count > 6 %}
        <a href="javascript:;" onclick="getMoreDocs('event', '#event_offset', '.more_event', '.event-card')" class="more more_event"> 更多結果 </a>
        <input type="hidden" id="event_offset" value="6">
        {% endif %}
      </div>


      <!----- 計畫徵求 ----->
      <div class="item item_project">
        <div class="titlebox_line">
          <div class="title">
            <p>計畫徵求 ({{ project.count }})</p>
            <div class="line"></div>
          </div>
        </div>
        {% if project.count > 0 %}
        <ul class="card_list_2 project-card">
          {% for i in project.rows %}
          <li>
            <div class="nstitle">{{ i.title|highlight:keyword }}</div>
            <p>{{ i.content|highlight:keyword }}</p>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <!--無資時料顯示-->
        <div class="no_data">暫無資料</div>
        {% endif %} 
        {% if project.count > 6 %}
        <!--超過6個才有更多按鈕-->
        <a href="javascript:;" onclick="getMoreDocs('project', '#project_offset', '.more_project', '.project-card')" class="more more_project"> 更多結果 </a>
        <input type="hidden" id="project_offset" value="6">
        {% endif %}
      </div>


      <!----- 開放資料相關資源 ----->
      <div class="item item_resource">
        <div class="titlebox_line">
          <div class="title">
            <p>開放資料相關資源 ({{ resource.count }})</p>
            <div class="line"></div>
          </div>
        </div>
        <ul class="edu_list three_set resource-card">
          {% if resource.count > 0 %} {% for i in resource.rows %}
          <li>
            <div class="item items" style="height: 100%">
              <div class="cate_dbox">
                <div class="cate pdf">{{ i.extension }}</div>
                <div class="date">{{ i.date }}</div>
              </div>
              <a href="{% static i.url %}" class="title"> {{ i.title|highlight:keyword }} </a>
              <a href="{% static i.url %}" download class="dow_btn"> </a>
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="no_data" style="width: 100%">暫無資料</div>
        {% endif %} 
        {% if resource.count > 6 %}
        <a href="javascript:;" onclick="getMoreDocs('resource', '#resource_offset', '.more_resource', '.resource-card')" class="more more_resource"> 更多結果 </a>
        <input type="hidden" id="resource_offset" value="6">
        {% endif %}
      </div>
    </div>


  </div>
</div>

<!-- 自然史典藏欄位選擇 -->
<div class="popbg col-choice" style="display: none;">
	<div class="ovhy">
		<div class="wbox_center">
			<div class="xx">
			</div>
			<div class="catetitle">
				<div class="titlebox">欄位選項</div>	
				<button class="selt">全選</button>
				<button class="selt">重置</button>
			</div>
			<ul class="catalist">
				<li>
					<input type="checkbox" class="chebox" checked="checkbox">
					<p>中文名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>學名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" checked="checkbox">
					<p>典藏單位</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>Namecode</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>館藏號</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>分層等級</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>標本類型</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>採集日期</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>採集地</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" checked="checkbox">
					<p>數量</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" checked="checkbox">
					<p>採集者</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>採集號</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>採集類型</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>資料集名稱</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>資料集聯絡人</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>經度</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>緯度</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>座標系統</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" checked="checkbox">
					<p>座標誤差</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" checked="checkbox">
					<p>座標是否有模糊化</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" checked="checkbox">
					<p>模糊化程度</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" >
					<p>授權狀況</p>
				</li>
			</ul>
			<button class="send_bt">確認</button>
		</div>
	</div>
</div>

<!-- 物種出現紀錄欄位選擇 -->
<div class="popbg occ-choice" style="display: none;">
	<div class="ovhy">
		<div class="wbox_center">
			<div class="xx">
			</div>
			<div class="catetitle">
				<div class="titlebox">欄位選項</div>	
				<button class="selt">全選</button>
				<button class="selt">重置</button>
			</div>
			<ul class="catalist">
				<li>
					<input type="checkbox" class="chebox" id="occ-common_name_c">
					<p>中文名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-scientificName">
					<p>學名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-alternative_name_c">
					<p>中文別名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-synonyms">
					<p>同物異名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-taxonRank">
					<p>分類層級</p>
				</li>				
				<li>
					<input type="checkbox" class="chebox" id="occ-sensitiveCategory">
					<p>敏感層級</p>
				</li>				
        <li>
					<input type="checkbox" class="chebox" id="occ-rightsHolder">
					<p>來源資料庫</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-scientificNameID">
					<p>Namecode</p>
				</li>

				<li>
					<input type="checkbox" class="chebox" id="occ-eventDate">
					<p>觀察日期</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-locality">
					<p>出現地</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-organismQuantity">
					<p>數量</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-organismQuantityType">
					<p>數量單位</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-recordedBy">
					<p>紀錄者</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-verbatimLongitude">
					<p>經度</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-verbatimLatitude">
					<p>緯度</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-verbatimSRS">
					<p>空間參考系統</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-verbatimCoordinateSystem">
					<p>座標系統</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-coordinateUncertaintyInMeters">
					<p>座標誤差</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-dataGeneralizations">
					<p>座標是否有模糊化</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-coordinatePrecision">
					<p>座標模糊化程度</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-basisOfRecord">
					<p>資料基底</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-license">
					<p>授權狀況</p>
				</li>
			</ul>
			<button class="send_bt">確認</button>
		</div>
	</div>
</div>

{% endblock body %} 

{% block script %}
<script>
  $(".mb_fixed_btn").on("click", function (event) {
    $(".mbmove").toggleClass("open");
    $(this).toggleClass("now");
  });

  $(".rd_click").on("click", function (event) {
    $(".rd_click").closest("li").removeClass("now");
    $(".rd_click").closest("li").find(".second_menu").slideUp();
    $(this).closest("li").toggleClass("now");
    $(this).closest("li").find(".second_menu").slideToggle();
  });


  $(".second_menu a").on("click", function (event) {
    $(".second_menu a").removeClass("now");
    $(this).addClass("now")
  });

  function focusComponent(item_class){
    // 不顯示最底層
    $('.record_title').remove()
    $('.result_inf_top').remove()
    $('.result_table').remove()
    $('.page_number').remove()

    if (item_class == 'all'){
      $('.rightbox_content .item').css({display: ''})
      // 如果是再底下一個階層則不顯示
      $('.rightbox_content .subitem').css({display: 'none'})
    } else {
      $(`.rightbox_content .${item_class}`).css({display: ''})
      $('.rightbox_content .item').not($(`.${item_class}`)).not($('.items')).css({display: 'none'})
    }
  }

  function getRecords(record_type,key,value,scientific_name,limit,page){
    // hide all items
    $('.rightbox_content .item').css({display: 'none'})

    // 移除前一次的紀錄
    $('.record_title').remove()
    $('.result_inf_top').remove()
    $('.result_table').remove()
    $('.page_number').remove()

    // append rows
    //if (! $(`.item_${record_type}_${key}`).length){
      $.ajax({
          url: "{% url 'get_records' %}",
          data: { record_type: record_type,
                  keyword: '{{ keyword }}',
                  csrfmiddlewaretoken: '{{ csrf_token }}',
                  key: key,
                  value: value,
                  scientific_name: scientific_name,
                  limit: limit,
                  page: page},
          type: 'POST',
          dataType : 'json',
      })
      .done(function(response) {
        console.log(response)
        $('.rightbox_content').append(`
        <div class="titlebox_line record_title">
          <div class="title">
              <p>${response.title} > 結果列表</p>
              <div class="line"></div>
          </div>
        </div>
        <div class="result_inf_top">
          <button class="cate_btn" onclick="popupField('${record_type}')">欄位選項 +</button>
          <p class="datenum">資料筆數 ： ${limit}</p>
        </div>
        <div class="result_table">
          <table cellspacing="0" cellspacing="0" class="table_style1 record_table">
          </table>						
        </div>    
        `)
        var table_title = document.createElement("tr");
        table_title.classList.add('table_title');
        let map_dict = response.map_dict;
        for (let i = 0; i < response.selected_col.length; i++) {
            var this_td = document.createElement("td");
            var text = document.createTextNode(map_dict[response.selected_col[i]]);
            //var title = map_dict[text]
            this_td.appendChild(text);
            table_title.appendChild(this_td); 
        }

        // append 功能
        var function_td = document.createElement("td");
        var text = document.createTextNode('功能');
        function_td.appendChild(text);
        table_title.appendChild(function_td); 

        $('.record_table').append(table_title);
        
        // append rows
        for (let i = 0; i < response.rows.length; i++) {
          let tmp = response.rows[i]
          let tmp_td
          for (let j = 0; j < response.selected_col.length; j++){
          tmp_td += `<td>${tmp[response.selected_col[j]]}</td>`}
          tmp_td += `<td><a href="#" class="more">查看</a></td>`
          $('.record_table').append(
            `<tr>${tmp_td}</tr>`)
        }

        // append pagination
        // 判斷是否有下一頁
        if (response.total_page > 1){
        $('.result_table').after(
          `<div class="page_number">
						<a href="javascript:;" class="num now"> ${response.current_page}</a>
					</div>`
        )}						
        // append previous & next page 
        if ((response.current_page - 1) > 0 ){
          $('.page_number').prepend(`
          <a href="javascript:;" onclick="getRecords('${record_type}','${key}','${value}','${scientific_name}','${limit}','1')" class="num">1</a>
          <a href="javascript:;" onclick="getRecords('${record_type}','${key}','${value}','${scientific_name}','${limit}','${response.current_page - 1}')" class="pre">
            <span></span>上一頁
          </a>
          <a href="javascript:;" onclick="getRecords('${record_type}','${key}','${value}','${scientific_name}','${limit}','${response.current_page - 1}')" class="num">${response.current_page - 1}</a>`)
        } else {
          $('.page_number').prepend(`
          <a href="javascript:;" class="num">1</a>
          <a href="javascript:;" class="pre">
            <span></span>上一頁
          </a>`)
        }        
        if (response.current_page < response.total_page){
          $('.page_number').append(`
          <a href="javascript:;" onclick="getRecords('${record_type}','${key}','${value}','${scientific_name}','${limit}','${response.current_page +1}')" class="num">${response.current_page +1}</a>
          <a href="javascript:;" onclick="getRecords('${record_type}','${key}','${value}','${scientific_name}','${limit}','${response.current_page + 1}')" class="next">
            下一頁<span></span>
          </a>
          <a href="javascript:;" onclick="getRecords('${record_type}','${key}','${value}','${scientific_name}','${limit}','${response.total_page}')" class="num">${response.total_page}</a>`)
        } else {
          $('.page_number').append(`
          <a href="javascript:;" class="next">
            下一頁<span></span>
          </a>
          <a href="javascript:;" class="num">${response.total_page}</a>
          `)
        }
        
      })
      .fail(function( xhr, status, errorThrown ) {
        console.log( 'Error: ' + errorThrown + 'Status: ' + status + xhr)
      })
    //} else {
    }
  


  function focusCards(record_type,key){
    // 如果focus已存在則不呼叫ajax，但顯示出來
    $('.record_title').remove()
    $('.result_inf_top').remove()
    $('.result_table').remove()
    $('.page_number').remove()

    if (! $(`.item_${record_type}_${key}`).length){
      $.ajax({
          url: "{% url 'get_focus_cards' %}",
          data: { record_type: record_type,
                  keyword: '{{ keyword }}',
                  csrfmiddlewaretoken: '{{ csrf_token }}',
                  key: key },
          type: 'POST',
          dataType : 'json',
      })
      .done(function(response) {
        // append item area
        $('.rightbox_content').append(
          `<div class="item subitem ${response.item_class}">
            <div class="titlebox_line">
              <div class="title">
                <p>${response.title} (${response.total_count})</p>
                <div class="line"></div>
              </div>
            </div>
            <ul class="card_list_1 ${response.card_class}">
            </ul>
          </div>`)
        // append cards
        for (let i = 0; i < response.data.length; i++) {
          let x = response.data[i];
          let html;
          if ( x.matched_col != '中文名' && x.matched_col != '學名'){
            html = `
            <li onclick="getRecords('${record_type}','${x.matched_col}','${x.matched_value.replace('<span class="col_red">', "").replace('</span>','')}','${ x.val.replace('<span class="col_red">', "").replace('</span>','') }','${ x.count }','1')">
              <div class="num">${x.count}</div>
              <p>中文名：${x.common_name_c}</p>
              <p>學名${x.val}</p>
              <p>${ x.matched_col }：${x.matched_value}</p>
            </li>`
          } else {
            html = `
            <li onclick="getRecords('${record_type}','${x.matched_col }','${x.matched_value.replace('<span class="col_red">', "").replace('</span>','') }','${ x.val.replace('<span class="col_red">', "").replace('</span>','') }','${ x.count }','1')">
              <div class="num">${x.count}</div>
              <p>中文名：${x.common_name_c}</p>
              <p>學名${x.val}</p>
            </li>`
          }
          $(`.${response.card_class}`).append(
            html
          )}
        // append 更多結果 button if more than 9 cards
        if (response.has_more == true) {
          $(`.${response.card_class}`).after(`
            <a href="javascript:;" onclick="getMoreCards('.${response.card_class}','#${record_type}_${key}_offset','.${record_type}_${key}_more','true')" class="more ${record_type}_${key}_more"> 更多結果 </a>
            <input type="hidden" id="${record_type}_${key}_offset" value="9">`
          )
        }
          $(`.rightbox_content .${response.item_class}`).css({display: ''})
          $('.rightbox_content .item').not($(`.${response.item_class}`)).not($('.items')).css({display: 'none'})
        
      })
      .fail(function( xhr, status, errorThrown ) {
        console.log( 'Error: ' + errorThrown + 'Status: ' + status + xhr)
      })
    } else {
      $(`.rightbox_content .item_${record_type}_${key}`).css({display: ''})
      $('.rightbox_content .item').not($(`.item_${record_type}_${key}`)).not($('.items')).css({display: 'none'})
    }
  }

  function getMoreDocs(doc_type, offset_value, more_class, card_class){
    //console.log(doc_type, offset_value)
    let offset = $(offset_value).val()
    $.ajax({
        url: "{% url 'get_more_docs' %}",
        data: {
          doc_type: doc_type,
          keyword: '{{ keyword }}',
          csrfmiddlewaretoken: '{{ csrf_token }}',
          offset: offset,
        },
        type: 'POST',
        dataType : 'json',
    })
    .done(function(response) {
      (response.has_more==true) ? $(offset_value).val(Number(offset)+ 6 ) : $(more_class).css({display: 'none'})

      if (card_class == '.resource-card'){
        for (let i = 0; i < response.rows.length; i++) {
          let x = response.rows[i]
            $(card_class).append(`<li>
              <div class="item" style="height: 100%">
                <div class="cate_dbox">
                  <div class="cate pdf">${ x.extension }</div>
                  <div class="date">${ x.date }</div>
                </div>
                <a href="${ x.url }" class="title"> ${ x.title } </a>
                <a href="${ x.url }" download class="dow_btn"> </a>
              </div></li>`)
        }
      } else {
        for (let i = 0; i < response.rows.length; i++) {
          let x = response.rows[i]
            $(card_class).append(`
            <li>
              <div class="nstitle">${ x.title }</div>
              <p>${ x.content }</p>
            </li>`)
          }
      }
    })
    .fail(function( xhr, status, errorThrown ) {
      console.log( 'Error: ' + errorThrown + 'Status: ' + status + xhr)
    })


  }

  function getMoreCards(card_class, offset_value, more_type, is_sub){
    let record_type;
    (card_class == '.occ-card') ? record_type = 'occ' : record_type = 'col';
    let offset = $(offset_value).val()
    $.ajax({
        url: "{% url 'get_more_cards' %}",
        data: {
          card_class: card_class,
          keyword: '{{ keyword }}',
          csrfmiddlewaretoken: '{{ csrf_token }}',
          offset: offset,
          is_sub: is_sub,
        },
        type: 'POST',
        dataType : 'json',
    })
    .done(function(response) {
      (response.has_more==true) ? $(offset_value).val(Number(offset)+ 9 ) : $(more_type).css({display: 'none'})
      for (let i = 0; i < response.data.length; i++) {
        let x = response.data[i]
        if ( x.matched_col != '中文名' && x.matched_col != '學名'){
          $(card_class).append( `
          <li onclick="getRecords('${record_type}','${x.matched_col }','${x.matched_value.replace('<span class="col_red">', "").replace('</span>','') }','${ x.val.replace('<span class="col_red">', "").replace('</span>','') }','${ x.count }','1')">
            <div class="num">${x.count}</div>
            <p>中文名：${x.common_name_c}</p>
            <p>學名${x.val}</p>
            <p>${ x.matched_col }：${x.matched_value}</p>
          </li>` )
        } else {
          $(card_class).append( `
          <li onclick="getRecords('${record_type}','${x.matched_col }','${x.matched_value.replace('<span class="col_red">', "").replace('</span>','') }','${ x.val.replace('<span class="col_red">', "").replace('</span>','') }','${ x.count }','1')">
            <div class="num">${x.count}</div>
            <p>中文名：${x.common_name_c}</p>
            <p>學名${x.val}</p>
          </li>` )
        }
      }
    })
    .fail(function( xhr, status, errorThrown ) {
      console.log( 'Error: ' + errorThrown + 'Status: ' + status + xhr)
    })
  }

  function popupField(record_type){
    $(`.${record_type}-choice`).css({display: ''})
  }



</script>
{% endblock script %}
