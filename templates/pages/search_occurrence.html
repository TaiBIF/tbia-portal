{% extends 'base.html' %} {% load static %} 
{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin=""/>
<!--
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha512-gc3xjCmIy673V6MyOAZhIW93xhM9ei1I+gLbmFjUHIjocENRsLX/QUE1htk5q1XV2D/iie/VQ8DXI6Vu8bexvQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
-->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>
<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB3TnF7tI48DPI4Gy1GXKD/V3EExgAs1V+pRO7vwtS1LHg0Gw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB3TnF7tI48DPI4Gy1GXKD/V3EExgAs1V+pRO7vwtS1LHg0Gw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha512-gc3xjCmIy673V6MyOAZhIW93xhM9ei1I+gLbmFjUHIjocENRsLX/QUE1htk5q1XV2D/iie/VQ8DXI6Vu8bexvQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

{% endblock head %}
{% block style %}
<style>
  
  p.active {
    background: #3F5146;
    color: #FFF !important;
  }
  
  .circle-select {
    display: flex;
    margin-bottom: 10px
  }

  .circle-select p {
    width: 20%;
    font-size: 16px;
    color: #707070;
    margin: auto 0;
  }

  .circle-select select, .circle-select input {
    width: 90%;
    border-radius: 5px;
    border: 1px solid #ddd;
    height: 50px;
    font-size: 16px;
    padding: 0px 10px;
    color: #707070
  }

  .circle-select {
    display: flex;
    margin-bottom: 10px
  }

</style>
{% endblock style %}

{% block title %}物種出現紀錄查詢｜{% endblock %}
{% block body %}
<div class="path">
  <div class="main_1240">
    <a href="{% url 'index' %}" class="home"></a> <span>></span>
    <p>條件搜尋</p>
    <span>></span>
    <p>物種出現紀錄查詢</p>
  </div>
</div>

<div class="nbn_title">
  <h2>物種出現紀錄查詢</h2>
</div>

<div class="container_area">
  <div class="main_1240">
    <div class="search_condition_are">
      <form id="searchForm">
        <input type="hidden" name="record_type" value="occ">
        <input type="hidden" name="geojson_id" value="">
        <div class="secboxtop2">
          <div class="leftbox">
            <div class="two_input">
              <div class="input_item">
                <input type="text" name="name" placeholder="中文名/學名/中文別名" />
              </div>
            </div>
            <div class="two_input">
              <div class="input_item">
                <select name="rightsHolder" id="" required>
                  <option value="" readonly="true" selected>來源資料庫</option>
                  {% for i in holder_list %}
                  <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="input_item">
                <input name="taxonID" type="text" placeholder="TaiCOL物種編號" />
              </div>
            </div>
            <div class="two_input">
              <div class="input_item">
                <select name="sensitiveCategory" id="" required>
                  <option value="" readonly="true" selected>敏感層級</option>
                  {% for i in sensitive_list %}
                  <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="input_item">
                <select name="taxonRank" id="" required>
                  <option value="" readonly="true" selected>鑑定層級</option>
                  {% for i in rank_list %}
                  <option value="{{ i.1 }}">{{ i.0 }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="two_input">
              <div class="line_cneter">~</div>
              <div class="input_item">
                <input name="start_date" id="start_date" type="text" placeholder="觀察紀錄日期（起）" />
                <a onclick="$('#start_date').datepicker('show')" class="dateicon"></a>
              </div>
              <div class="input_item">
                <input name="end_date" id="end_date" type="text" placeholder="觀察紀錄日期（迄）" value="" />
                <a onclick="$('#end_date').datepicker('show')" class="dateicon"></a>
              </div>
            </div>
            <div class="two_input">
              <div class="input_item">
                <input name="locality" type="text" placeholder="出現地" />
              </div>
              <div class="input_item">
                <input name="organismQuantity" type="number" placeholder="數量" min="0" />
              </div>
            </div>
            <div class="two_input">
              <div class="input_item">
                <input name="recordedBy" type="text" placeholder="記錄者" />
              </div>
              <div class="input_item">
                <select name="basisOfRecord" required>
                  <option value="" readonly="true" selected>紀錄類型</option>
                  {% for i in basis_list %}
                  <option value="{{ i }}">{{ i }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="two_input">
              <div class="input_item">
                <input name="datasetName" type="text" placeholder="資料集名稱" />
              </div>
              <div class="input_item">
                <input name="resourceContacts" type="text" placeholder="資料集聯絡人" />
              </div>
            </div>
          </div>
          <div class="rightbox">
            <div class="title_area">
              <h3>空間查詢</h3>
              <a href="#" class="qmark"></a>
            </div>
            <div class="btn_area">
              <label class="btnupload">
                <p data-type="map" onclick="mapGeo(this)" style="width: 110px">地圖框選</p>
              </label>
              <label class="btnupload">
                <p data-type="circle" onclick="circleGeo(this)" style="width: 120px">圓中心框選</p>
              </label>
              <label class="btnupload">
                <p data-type="polygon" onclick="popupGeo(this)" style="width: 130px">上傳Polygon</p>
              </label>
              <label class="btnupload">
                <p onclick="clearGeo()">重設</p>  
              </label>
            </div>          
            <div class="map_img">
              <div class="imgbox" style="height: 390px; width: auto;">
                <div id="map" class="img"></div>
              </div>
            </div>
          </div>
        </div>
        </form>
        <button class="search_btn" onclick="submitSearch(1,'search')">搜尋</button>
    </div>
  </div>
</div>

<!-- 物種出現紀錄欄位選擇 -->
<div class="popbg occ-choice" style="display: none;">
	<div class="ovhy choice-ovhy">
		<div class="wbox_center">
			<div class="xx choice-xx">
			</div>
			<div class="catetitle">
				<div class="titlebox">欄位選項</div>	
				<button class="selt" onclick="selectAll('.occ-choice')">全選</button>
				<button class="selt" onclick="resetAll('.occ-choice')">重置</button>
			</div>
			<ul class="catalist">
				<li>
					<input type="checkbox" class="chebox" id="occ-common_name_c">
					<p>中文名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-scientificName">
					<p>學名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-alternative_name_c">
					<p>中文別名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-synonyms">
					<p>同物異名</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-taxonRank">
					<p>鑑定層級</p>
				</li>				
				<li>
					<input type="checkbox" class="chebox" id="occ-sensitiveCategory">
					<p>敏感層級</p>
				</li>				
        <li>
					<input type="checkbox" class="chebox" id="occ-rightsHolder">
					<p>來源資料庫</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-taxonID">
					<p>TaiCOL物種編號</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-eventDate">
					<p>觀察日期</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-locality">
					<p>出現地</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-organismQuantity">
					<p>數量</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-organismQuantityType">
					<p>數量單位</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-recordedBy">
					<p>記錄者</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-verbatimLongitude">
					<p>經度</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-verbatimLatitude">
					<p>緯度</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-verbatimSRS">
					<p>空間參考系統</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-verbatimCoordinateSystem">
					<p>座標系統</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-coordinateUncertaintyInMeters">
					<p>座標誤差</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-dataGeneralizations">
					<p>座標是否有模糊化</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-coordinatePrecision">
					<p>座標模糊化程度</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-basisOfRecord">
					<p>紀錄類型</p>
				</li>
				<li>				
					<input type="checkbox" class="chebox" id="occ-datasetName">
					<p>資料集名稱</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-resourceContacts">
					<p>資料集聯絡人</p>
				</li>
				<li>
					<input type="checkbox" class="chebox" id="occ-license">
					<p>授權狀況</p>
				</li>
			</ul>
			<button class="send_bt" onclick="sendSelected('occ')">確認</button>
		</div>
	</div>
</div>


<!--空間查詢popbox-->
<div class="popbg geojson_popup" style="display:none;">
	<div class="ovhy">
		<div class="wbox_center">
			<div class="xx">
			</div>
			<div class="titlegreen">
				空間查詢
			</div>
			<p class="shortxt">
        請以GeoJSON格式貼上欲查詢的Polygon：
			</p>
			<div class="from_area" style="height: 100%">
				<div class="txt_area">
					<textarea id="geojson_textarea" style="height: 300px"></textarea>
				</div>
        <p class="shortxt" style="text-align: right; color:#C65454">
          *僅支援Polygon（上限2.5 MB）
        </p>
        <p class="shortxt" style="text-align: right; color:#C65454">
          *Polygon會經過dissolve處理
        </p>
				<button class="send geojson_send">確認送出</button>
			</div>
		</div>
	</div>
</div>

<!--圓中心查詢popbox-->
<div class="popbg circle_popup" style="display:none; ">
	<div class="ovhy">
		<div class="wbox_center"  style="max-height: 380px">
			<div class="xx">
			</div>
			<div class="titlegreen">
				 圓中心框選
			</div>
			<div class="from_area" style="height: 100%">
				<div class="txt_area" style="margin-top: 5%">
          <div class="circle-select">
            <p>半徑</p>
            <select name="circle_radius" id="circle_radius" required>
              <option value="1">1KM</option>
              <option value="2">2KM</option>
              <option value="5">5KM</option>
              <option value="10">10KM</option>
              <option value="25">25KM</option>
              <option value="50">50KM</option>
            </select>
          </div>
          <div class="circle-select">
            <p>中心點經度</p>
            <input name="center_lon" type="text">
          </div>
          <div class="circle-select">
            <p>中心點緯度</p>
            <input name="center_lat" type="text">
          </div>
				</div>
				<button  style="margin-top: 5%"class="send circle_send">確認送出</button>
			</div>
		</div>
	</div>
</div>

{% endblock body %}
{% block script %}
<script>



  function downloadData(queryString, total_count) {
    if ('{{ user.is_authenticated }}'=='True'){

      $.ajax({
        url: "{% url 'send_download_request' %}",
        data: queryString + '&csrfmiddlewaretoken={{ csrf_token }}' + '&total_count=' + total_count,
        type: 'POST',
        dataType : 'json',
      })
      .done(function(response) {
        alert('請求已送出，下載檔案處理完成後將以email通知')

      })

      .fail(function( xhr, status, errorThrown ) {
        if (xhr.status==504){
          alert('要求連線逾時')
        } else {
          alert('發生未知錯誤！請聯絡管理員')
        }
        console.log( 'Error: ' + errorThrown + 'Status: ' + xhr.status)
      })
    } else {
      alert('請先登入')
    }

  }



  function downloadTaxon(queryString) {
    if ('{{ user.is_authenticated }}'=='True'){

      $.ajax({
        url: "{% url 'send_download_request' %}",
        data: queryString + '&csrfmiddlewaretoken={{ csrf_token }}' + '&taxon=yes',
        type: 'POST',
        dataType : 'json',
      })
      .done(function(result) {
        alert('請求已送出，下載檔案處理完成後將以email通知')
      })
      .fail(function( xhr, status, errorThrown ) {
        if (xhr.status==504){
          alert('要求連線逾時')
        } else {
          alert('發生未知錯誤！請聯絡管理員')
        }
        console.log( 'Error: ' + errorThrown + 'Status: ' + xhr.status)
      })
    } else {
      alert('請先登入')
    }
  }


    function getColor(d) {
      return d > 1000 ? '#C50101' :
              d > 500  ? '#D71414' :
              d > 200  ? '#E72424' :
              d > 100  ? '#F73535' :
              d > 50   ? '#FB4C4C' :
              d > 20   ? '#FB6262' :
              d > 10   ? '#FC7E7E' :
                        '#FD9696';
    }
    
    function style(feature) {
      return {
          fillColor: getColor(feature.properties.counts),
          weight: 1,
          opacity: 0.5,
          color: 'black',
          //dashArray: '3',
          fillOpacity: 1
      };
    }
    
    let map = L.map('map').setView([23.5, 121.2],7);
    L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    drawControl = new L.Control.Draw({
        draw : {
            position : 'topleft',
            polyline : false,
            rectangle : true,
            circle : false,
            polygon: true,
            marker: false,
            circlemarker: false
        },
        edit : {
          featureGroup: drawnItems,
          edit: false
        }
    });
    
    map.addControl(drawControl); 
    
    $('.leaflet-control.leaflet-draw').css('display', 'none')
    map.on(L.Draw.Event.CREATED, function (e) {
      var layer = e.layer;
      drawnItems.addLayer(layer);
    });
    
    map.on('zoomend', function zoomendEvent(ev) {
      var currentZoomLevel = ev.target.getZoom()
    
        if (currentZoomLevel < 5) {
          $('[class^=resultG_]').css('display','none')
          $('.resultG_100').css('display','')
        } else if (currentZoomLevel < 8){
          $('[class^=resultG_]').css('display','none')
          $('.resultG_10').css('display','')
        } else if (currentZoomLevel < 9){
          $('[class^=resultG_]').css('display','none')
          $('.resultG_5').css('display','')
        } else {
          $('[class^=resultG_]').css('display','none')
          $('.resultG_1').css('display','')
        }
    });
    

    
  $( function() {
  // date picker

    $( "#start_date" ).datepicker({ dateFormat: 'yy-mm-dd' });
    $( "#end_date" ).datepicker({ dateFormat: 'yy-mm-dd' });

    // 如果直接從帶有參數網址列進入
    changeAction(); 

    // 如果按上下一頁
    window.onpopstate = function(event) {
      drawnItems.clearLayers();
      $('.addG, .addC, .resultG_1, .resultG_10, .resultG_5, .resultG_100').remove()
      changeAction();
    };

  } );

  

  function changeAction(){
    let queryString = window.location.search;
    if (queryString.split('&').length>1){
      // 把條件填入表格

      let urlParams = new URLSearchParams(queryString);
      let entries = urlParams.entries(); 
      
      for(const [key, value] of entries) { 
        $(`[name=${key}]`).val(value)
          // map按鈕
          if (key == 'geo_type'){
            $(`p[data-type=${value}]`).addClass("active")
          }

          if (key == 'geojson') {
            if (urlParams.get('geo_type') == 'map') {
              geoJSON = L.geoJSON(JSON.parse(value)).addTo(map);
              drawnItems.addLayer(geoJSON);
              map.fitBounds(geoJSON.getBounds());
            } else if (urlParams.get('geo_type') == 'circle') {
              let circle = L.circle([urlParams.get('center_lat'),urlParams.get('center_lon')],
              parseInt(urlParams.get('circle_radius'),10)*1000, { className: 'addC'}).addTo(map);
              drawnItems.addLayer(circle);
              map.fitBounds(circle.getBounds());
            }
          }
          if ((key == 'geojson_id') && (value != '')){
              fetch(`/media/geojson/${value}.json`).then((res) => {
              if (res.ok) {
                $('#geojson_textarea').val(JSON.stringify(res.json()))
                $.getJSON(`/media/geojson/${value}.json`, function (ret) {
                  geoJSON = L.geoJSON(ret,{ className: 'addG'}).addTo(map);
                  map.fitBounds(geoJSON.getBounds());
                });
              } else {
                $(`p[data-type=polygon]`).removeClass("active")
              }
          });
                
        }
        
      }
      getRecordByURL(queryString,null)

    }

  }

  function setTable(response, queryString){
    drawnItems.clearLayers();
    $('.addG, .addC, .resultG_1, .resultG_10, .resultG_5, .resultG_100').remove()
    
    L.geoJSON(response.map_geojson.grid_1,{className: 'resultG_1',style: style}).addTo(map);
    L.geoJSON(response.map_geojson.grid_5,{className: 'resultG_5',style: style}).addTo(map);
    L.geoJSON(response.map_geojson.grid_10,{className: 'resultG_10',style: style}).addTo(map);
    L.geoJSON(response.map_geojson.grid_100,{className: 'resultG_100',style: style}).addTo(map);
    //map.fitBounds(geoResult.getBounds());

    $('.resultG_1, .resultG_5, .resultG_10, .resultG_100').css('display','none')

    if (map.getZoom() < 5) {
      $('.resultG_100').css('display','')
    } else if (map.getZoom() < 8){
      $('.resultG_10').css('display','')
    } else if (map.getZoom() < 9){
      $('.resultG_5').css('display','')
    } else {
      $('.resultG_1').css('display','')
    }
      // 如果有資料回傳則顯示table
      $('.search_condition_are').after(`
      <div class="sc_result">
        <div class="result_inf_top">
          <button class="cate_btn" onclick="popupField()">欄位選項 +</button>
          <div class="rightmore">
            <p class="datenum">資料筆數 ： ${response.count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</p>
            <button class="dw" onclick="downloadData('${queryString}', ${response.count})">資料下載</button>
            <button class="dw" onclick="downloadTaxon('${queryString}')">名錄下載</button>
            <a href="#" class="qmark"></a>
            <button class="dw">申請單次使用去模糊化敏感資料</button>
            <a href="#" class="qmark"></a>
          </div>
        </div>
        <div class="result_table" style="overflow-x: auto;">
          <table cellspacing="0" cellspacing="0" class="table_style1 record_table">
          </table>						
        </div>
      </div>`)
      // table title
      var table_title = document.createElement("tr");
      table_title.classList.add('table_title');
      let map_dict = response.map_dict;

      for (let i = 0; i < Object.keys(map_dict).length; i++) {
          var this_td = document.createElement("td");
          this_td.className = `row-${Object.keys(map_dict)[i]}`;
          this_td.style.cssText = 'display:none';
          var text = document.createTextNode(map_dict[Object.keys(map_dict)[i]]);
          this_td.appendChild(text);
          table_title.appendChild(this_td); 
      }
      var function_td = document.createElement("td");
      var text = document.createTextNode('功能');
      function_td.appendChild(text);
      table_title.appendChild(function_td); 

      $('.record_table').append(table_title);
      
      // append rows
      for (let i = 0; i < response.rows.length; i++) {
        let tmp = response.rows[i];
        let tmp_td;
        let tmp_value;
        for (let j = 0; j < Object.keys(map_dict).length; j++){
          tmp_value = tmp[Object.keys(map_dict)[j]];
          if (tmp_value == null){
            tmp_td += `<td class="row-${Object.keys(map_dict)[j]}" style="display: none"></td>`
          } else {
            tmp_td += `<td class="row-${Object.keys(map_dict)[j]}" style="display: none">${tmp_value}</td>`
          }
        }
        let url_mask = "{% url 'occurrence_detail' 12345 %}".replace(/12345/, tmp.id.toString());
        tmp_td += `<td><a href=${url_mask} class="more" target="_blank">查看</a></td>`
        $('.record_table').append(
          `<tr>${tmp_td}</tr>`)
      }
  }

  function getRecordByURL(queryString,page) {
    // 如果從頁碼點選, 修改page參數
    if (page != null){
      let urlParams = new URLSearchParams(queryString);
      urlParams.set('page',page)
      queryString = urlParams.toString()
      history.pushState(null, '', window.location.pathname + '?'  + queryString);
    }

    $.ajax({
      url: "{% url 'get_conditional_records' %}",
      data: queryString + '&csrfmiddlewaretoken={{ csrf_token }}',
      type: 'POST',
      dataType : 'json',
    })
    .done(function(response) {
      // clear previous results
      $('.sc_result').remove()
      if (response.count == 0){
        $('.search_condition_are').after(`<div class="sc_result"><div class="no_data">暫無資料</div></div>`)
      } else {
        // 把之前的清掉


        setTable(response, queryString)

        // 欄位選項
        $(`input[id^="occ-"]`).prop('checked',false)
        // show selected columns
        for (let i = 0; i < response.selected_col.length; i++) {
          $(`.row-${response.selected_col[i]}`).show();
          $(`#occ-${response.selected_col[i]}`).prop('checked',true);}

        // disable checkebox for common_name_c & scientificName
        $('#occ-common_name_c, #occ-scientificName').prop('disabled',true);
        $('#occ-common_name_c, #occ-scientificName').prop('checked',true);

        // append pagination
        if (response.total_page > 1){  // 判斷是否有下一頁，有才加分頁按鈕
          $('.result_table').after(
            `<div class="page_number">
              <a href="javascript:;" class="pre">
                <span></span>
              </a>
              <a href="javascript:;" class="next">
                <span></span>
              </a>
            </div>`)}		
        
        let html = ''
        for (let i = 0; i < response.page_list.length; i++) {
          
          if (response.page_list[i] == response.current_page){
            html += `<a href="javascript:;" onclick="getRecordByURL('${queryString}',${response.page_list[i]})" class="num now">${response.page_list[i]}</a>  `;
          } else {
            html += `<a href="javascript:;" onclick="getRecordByURL('${queryString}',${response.page_list[i]})" class="num">${response.page_list[i]}</a>  `
          }
        }
        $('.pre').after(html)

        // 如果有上一頁，改掉pre的onclick
        if ((response.current_page - 1) > 0 ){
          $('.pre').attr('onclick',`getRecordByURL('${queryString}',${response.current_page - 1})`);
        }
        // 如果有下一頁，改掉next的onclick
        if (response.current_page < response.total_page){
          $('.next').attr('onclick',`getRecordByURL('${queryString}',${response.current_page + 1})`);
        }

        // 如果有前面的page list, 加上...
        if (response.current_page > 5){
          $('.pre').after(`<a href="javascript:;" style="border: 0" class="num" onclick="getRecordByURL('${queryString}',${response.current_page -5 })">...</a> `)
        }
        // 如果有後面的page list, 加上...
        if (response.page_list[response.page_list.length - 1] < response.total_page){
          if (response.current_page +5 > response.total_page){
            $('.next').before(`<a href="javascript:;" style="border: 0" class="num" onclick="getRecordByURL('${queryString}',${response.total_page})">...</a> `)
          } else {
            $('.next').before(`<a href="javascript:;" style="border: 0" class="num" onclick="getRecordByURL('${queryString}',${response.current_page +5})">...</a>`)
          }
        }
    }
    })

    .fail(function( xhr, status, errorThrown ) {
      if (xhr.status==504){
        alert('要求連線逾時')
      } else {
        alert('發生未知錯誤！請聯絡管理員')
      }
      console.log( 'Error: ' + errorThrown + 'Status: ' + xhr.status)
    })

  }


  // 從地圖框選
  function mapGeo(e){
    $('.addC, .addG').remove()
    $('p.active').removeClass('active')
    $(e).addClass('active');
    $('.leaflet-control.leaflet-draw').css('display', '')
    //$('.geojson_popup').css({display: ''})
  }

  // 從圓中心框選
  function circleGeo(e){
    $('.addC, .addG').remove()
    drawnItems.clearLayers();
    $('p.active').removeClass('active')
    $(e).addClass('active');
    $('.leaflet-control.leaflet-draw').css('display', 'none')
    $(".circle_popup").show()
  }


  function popupGeo(e){
    $('.addC').remove()
    drawnItems.clearLayers();
    $('p.active').removeClass('active')
    $(e).addClass('active');
    $('.leaflet-control.leaflet-draw').css('display', 'none')
    $(".geojson_popup").show()
  }

  function clearGeo(){
    $('p.active').removeClass('active')
    $('.leaflet-control.leaflet-draw').css('display', 'none')
    drawnItems.clearLayers();
    $('.addG, .addC').remove()
     $('input[name=center_lat]').val('')
    $('input[name=center_lon]').val('')
    $("#circle_radius").val("1").trigger("change");
    $('#geojson_textarea').val('')
    $('input[name=geojson_id]').val('')
  }


  $('.circle_send').click( function(){
    // 先把舊的移除
    $('.addC, [class^=resultG_]').remove()
    if (($('input[name=center_lat]').val() == '') | ($('input[name=center_lon]').val() == '')){
      alert('框選失敗！請檢查經緯度格式是否正確')
    } else {
      try {
        let circle = L.circle([$('input[name=center_lat]').val(),$('input[name=center_lon]').val()],
                    parseInt($('select[name=circle_radius]').val(),10)*1000, { className: 'addC'}).addTo(map);
        drawnItems.addLayer(circle);
        map.fitBounds(circle.getBounds());
        $(".circle_popup").hide()
      } catch (e) {
        alert('框選失敗！請檢查經緯度格式是否正確')
      }
    }
  })



  $('.geojson_send').click( function(){
    // 先把舊的移除
    $('.addG, [class^=resultG_]').remove()
    try {
      let geoObj = JSON.parse($('#geojson_textarea').val());
      //geoJSON = L.geoJSON(geoObj,{ className: 'addG'}).addTo(map);

      //var ucbRegions = L.geoJson(data).addTo(map);
      var regionsDissolved = turf.dissolve(geoObj);
      

      $.ajax({
        url: "{% url 'save_geojson' %}",
        data: { geojson_text: JSON.stringify(regionsDissolved ),csrfmiddlewaretoken:'{{ csrf_token }}'},
        type: 'POST',
        dataType : 'json',
      })
      .done(function(response) {
        $('input[name=geojson_id]').val(response.geojson_id)
      })
      .fail(function( xhr, status, errorThrown ) {
        if (xhr.status==504){
          alert('要求連線逾時')
        } else {
          alert('發生未知錯誤！請聯絡管理員')
        }
        console.log( 'Error: ' + errorThrown + 'Status: ' + xhr.status)
      })

      geoJSON = L.geoJSON(regionsDissolved,{ className: 'addG'}).addTo(map);
    
      map.fitBounds(geoJSON.getBounds());
      $(".geojson_popup").hide()
    } catch (e) {
      alert('上傳失敗！請檢查GeoJSON格式是否正確或檔案是否超過大小上限')
    }
  })


  // submit search form
function submitSearch (page, from){

    let map_condition = '';
    if ($('p.active').data('type')=='map'){
      map_condition = '&' + $.param({'geojson': JSON.stringify(drawnItems.toGeoJSON()),'geo_type': 'map'})
    } else if ($('p.active').data('type')=='polygon'){
      map_condition = '&' + $.param({'geo_type': 'polygon'})
    } else if ($('p.active').data('type')=='circle'){
      map_condition = '&' + $.param({'geojson': JSON.stringify(drawnItems.toGeoJSON()), 'circle_radius': $('select[name=circle_radius]').val(),
      'center_lon': $('input[name=center_lon]').val(), 'center_lat': $('input[name=center_lat]').val(), 'geo_type': 'circle'})
    }

    // 如果是按搜尋，重新給query參數，若是從分頁則不用
    if (from == 'search'){
      //window.condition = $('#searchForm').serialize() + '&' + $.param({'geojson': $('#geojson_textarea').val()})
      
      var form = $(); //Initialize empty jQuery object

      //Iterate through all inputs, textareas
      $('#searchForm input,#searchForm select').each(function() {
          //Add to jQuery object if not empty
          if ($(this).val().length) {
             form = form.add($(this)); 
          }
      })
  
      window.condition = form.serialize() + map_condition


     } 
    history.pushState(null, '', window.location.pathname + '?' + window.condition + '&' + $.param({'page': page})+ '&from=' + from);


    $.ajax({
      url: "{% url 'get_conditional_records' %}",
      data: window.condition + '&' + $.param({'page': page})+ '&from=' + from + '&csrfmiddlewaretoken={{ csrf_token }}',
      type: 'POST',
      dataType : 'json',
    })
    .done(function(response) {
      // clear previous results
      $('.sc_result').remove()
      if (response.count == 0){
        $('.search_condition_are').after(`<div class="sc_result"><div class="no_data">暫無資料</div></div>`)
      } else {


      setTable(response, window.condition)

      // 判斷是從分頁或搜尋點選
        if (from == 'search'){
          // uncheck all first
          $(`input[id^="occ-"]`).prop('checked',false)
          // show selected columns
          for (let i = 0; i < response.selected_col.length; i++) {
            $(`.row-${response.selected_col[i]}`).show();
            $(`#occ-${response.selected_col[i]}`).prop('checked',true);}
        } else {
          sendSelected()
        }

        // disable checkebox for common_name_c & scientificName
        $('#occ-common_name_c, #occ-scientificName').prop('disabled',true);
        $('#occ-common_name_c, #occ-scientificName').prop('checked',true);

        // append pagination
        if (response.total_page > 1){  // 判斷是否有下一頁，有才加分頁按鈕
          $('.result_table').after(
            `<div class="page_number">
              <a href="javascript:;" class="pre">
                <span></span>
              </a>
              <a href="javascript:;" class="next">
                <span></span>
              </a>
            </div>`)}		
        
        let html = ''
        for (let i = 0; i < response.page_list.length; i++) {
          if (response.page_list[i] == response.current_page){
            html += `<a href="javascript:;" onclick="submitSearch(${response.page_list[i]}, 'page')" class="num now">${response.page_list[i]}</a>  `;
          } else {
            html += `<a href="javascript:;" onclick="submitSearch(${response.page_list[i]}, 'page')" class="num">${response.page_list[i]}</a>  `
          }
        }
        $('.pre').after(html)

        // 如果有上一頁，改掉pre的onclick
        if ((response.current_page - 1) > 0 ){
          $('.pre').attr('onclick',`submitSearch(${response.current_page - 1}, 'page')`);
        }
        // 如果有下一頁，改掉next的onclick
        if (response.current_page < response.total_page){
          $('.next').attr('onclick',`submitSearch(${response.current_page + 1}, 'page')`);
        }

        // 如果有前面的page list, 加上...
        if (response.current_page > 5){
          $('.pre').after(`<a href="javascript:;" style="border: 0" class="num" onclick="submitSearch(${response.current_page -5 }, 'page')">...</a> `)
        }
        // 如果有後面的page list, 加上...
        if (response.page_list[response.page_list.length - 1] < response.total_page){
          if (response.current_page +5 > response.total_page){
            $('.next').before(`<a href="javascript:;" style="border: 0" class="num" onclick="submitSearch(${response.total_page}, 'page')">...</a> `)
          } else {
            $('.next').before(`<a href="javascript:;" style="border: 0" class="num" onclick="submitSearch(${response.current_page +5}, 'page')">...</a>`)
          }
        }
    }
    })

    .fail(function( xhr, status, errorThrown ) {
      if (xhr.status==504){
        alert('要求連線逾時')
      } else {
        alert('發生未知錯誤！請聯絡管理員')
      }
      console.log( 'Error: ' + errorThrown + 'Status: ' + xhr.status)
    })
  }

  function popupField(){
    $(`.occ-choice`).css({display: ''})
    window.not_selected = $(`.occ-choice input:not(:checked)`)
    window.selected = $(`.occ-choice input:checked`)
  }

  function sendSelected(){
    let selected_field = $(`.occ-choice input:checked`)
    // 所有都先隱藏，除了common_name_c & scientificName
    $('td[class^="row-"]').hide();
    $('.row-common_name_c, .row-scientificName').show();
    // 再顯示選擇的欄位
    for (let i = 0; i < selected_field.length; i++) {
      $(`td.row-${selected_field[i].id.split('-')[1]}`).show();
    }
    $(".popbg").hide();
  }

  function resetAll(){
    $(`.occ-choice input:checkbox:not(:disabled)`).prop('checked', false);
  }

  function selectAll(){
    $(`.occ-choice input:checkbox`).prop('checked', true);
  }

  $(".popbg .xx,.popbg .ovhy").click(function (e) {
    if ($(event.target).hasClass("choice-xx") || $(event.target).hasClass("choice-ovhy")) {
      window.not_selected.prop('checked', false);
      window.selected.prop('checked', true);
    }
  });

  // disable string input in 數量單位
  $("input[name=organismQuantity]").on("keyup", function() {
    this.value = this.value.replace(/\D/g,'');
  });

</script>
{% endblock %}